# .github/workflows/tfsuit.yml
name: tfsuit scan

on:
  pull_request:
    paths: ["**/*.tf", "tfsuit.hcl"]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: 1.24

      - name: Build tfsuit
        run: go build -o tfsuit ./cmd/tfsuit

      - name: Run tfsuit → SARIF
        id: tfsuit
        continue-on-error: true          # ← no detiene el job
        run: |
            ./tfsuit --format sarif --fail ./ > tfsuit.sarif
            echo "exit_code=$?" >> "$GITHUB_OUTPUT"

      - name: Upload SARIF
        if: always()                     # ← se ejecuta aunque el paso anterior “fallara”
        uses: github/codeql-action/upload-sarif@v3
        with:
            sarif_file: tfsuit.sarif

      # Paso final: hace fallar el job si salieron violaciones
      - name: Fail if tfsuit found issues
        if: steps.tfsuit.outputs.exit_code != '0'
        run: exit 1
